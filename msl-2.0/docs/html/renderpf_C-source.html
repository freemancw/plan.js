<HEAD>
<TITLE>Motion Strategy Library</TITLE>
</HEAD>

<body bgcolor="#ffffff">

<center><img src="msl.jpg"></center>

<p>


<!-- Generated by Doxygen 1.2.2 on Wed Aug 29 23:26:45 2001 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>renderpf.C</h1><a href="renderpf_C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">//----------------------------------------------------------------------</font>
00002 <font class="comment">//               The Motion Strategy Library (MSL)</font>
00003 <font class="comment">//----------------------------------------------------------------------</font>
00004 <font class="comment">//</font>
00005 <font class="comment">// Copyright (c) 1998-2000 Iowa State University and Steve LaValle.  </font>
00006 <font class="comment">// All Rights Reserved.</font>
00007 <font class="comment">// </font>
00008 <font class="comment">// Permission to use, copy, and distribute this software and its </font>
00009 <font class="comment">// documentation is hereby granted free of charge, provided that </font>
00010 <font class="comment">// (1) it is not a component of a commercial product, and </font>
00011 <font class="comment">// (2) this notice appears in all copies of the software and</font>
00012 <font class="comment">//     related documentation. </font>
00013 <font class="comment">// </font>
00014 <font class="comment">// Iowa State University and the author make no representations</font>
00015 <font class="comment">// about the suitability or fitness of this software for any purpose.  </font>
00016 <font class="comment">// It is provided "as is" without express or implied warranty.</font>
00017 <font class="comment">//----------------------------------------------------------------------</font>
00018 
00019 <font class="preprocessor">#include &lt;math.h&gt;</font>
00020 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00021 
00022 <font class="preprocessor">#include "<a class="code" href="renderpf_h.html">renderpf.h</a>"</font>
00023 <font class="preprocessor">#include "<a class="code" href="defs_h.html">defs.h</a>"</font>
00024 
00025 
<a name="l00026"></a><a class="code" href="renderpf_C.html#a0">00026</a> <font class="preprocessor">#define CONTROLPANEL_CENTER_X -0.22
</font><a name="l00027"></a><a class="code" href="renderpf_C.html#a1">00027</a> <font class="preprocessor"></font><font class="preprocessor">#define CONTROLPANEL_CENTER_Z -0.37
</font><a name="l00028"></a><a class="code" href="renderpf_C.html#a2">00028</a> <font class="preprocessor"></font><font class="preprocessor">#define CONTROLPANEL_WIDTH 0.2
</font><a name="l00029"></a><a class="code" href="renderpf_C.html#a3">00029</a> <font class="preprocessor"></font><font class="preprocessor">#define CONTROLPANEL_HEIGHT 0.1
</font><a name="l00030"></a><a class="code" href="renderpf_C.html#a4">00030</a> <font class="preprocessor"></font><font class="preprocessor">#define CONTROLPANEL_BAR_WIDTH 0.18
</font><a name="l00031"></a><a class="code" href="renderpf_C.html#a5">00031</a> <font class="preprocessor"></font><font class="preprocessor">#define CONTROLPANEL_BAR_HEIGHT 0.005
</font><a name="l00032"></a><a class="code" href="renderpf_C.html#a6">00032</a> <font class="preprocessor"></font><font class="preprocessor">#define CONTROLPAD_WIDTH 0.01
</font><a name="l00033"></a><a class="code" href="renderpf_C.html#a7">00033</a> <font class="preprocessor"></font><font class="preprocessor">#define CONTROLPAD_HEIGHT 0.02
</font>00034 <font class="preprocessor"></font>
00035 <font class="comment">// Range of speeds: 2^-ANIMATING_SPEED_FACTOR to 2^ANIMATING_SPEED_FACTOR</font>
<a name="l00036"></a><a class="code" href="renderpf_C.html#a8">00036</a> <font class="preprocessor">#define ANIMATING_SPEED_FACTOR 10
</font>00037 <font class="preprocessor"></font>
00038 
00040 <font class="comment">//</font>
00041 <font class="comment">// RenderPerformer Class</font>
00042 <font class="comment">//
</font>00044 <font class="comment"></font>
00045 SharedData* RenderPerformer::Shared;
00046 
<a name="l00047"></a><a class="code" href="class_RenderPerformer.html#a0">00047</a> <a class="code" href="class_RenderPerformer.html#a0">RenderPerformer::RenderPerformer</a>(): <a class="code" href="class_Render.html">Render</a>()
00048 {
00049 
00050 }
00051 
00052 
<a name="l00053"></a><a class="code" href="class_RenderPerformer.html#a1">00053</a> <a class="code" href="class_RenderPerformer.html#a0">RenderPerformer::RenderPerformer</a>(string filepath=<font class="stringliteral">""</font>): <a class="code" href="class_Render.html">Render</a>(filepath)
00054 {
00055 
00056 }
00057 
00058 
<a name="l00059"></a><a class="code" href="class_RenderPerformer.html#a2">00059</a> <a class="code" href="class_RenderPerformer.html#a0">RenderPerformer::RenderPerformer</a>(<a class="code" href="class_Scene.html">Scene</a> *s, 
00060                                  string filepath): <a class="code" href="class_Render.html">Render</a>(s,filepath)
00061 {
00062 
00063 }
00064 
00065 
00066 
<a name="l00067"></a><a class="code" href="class_RenderPerformer.html#b1">00067</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b1">RenderPerformer::LoadEnvironment</a>(pfGroup *env)<font class="keyword"></font>{
00068   list&lt;string&gt;::iterator object;
00069   pfNode *root;
00070 
00071   <a class="code" href="defs_h.html#a8">forall</a>(object, EnvList)<font class="keyword"></font>{
00072     <font class="comment">// Append to Performer search path</font>
00073     <font class="keywordflow">if</font> (!strstr((*object).c_str(),<font class="stringliteral">"."</font>)) {
00074       root = <a class="code" href="class_RenderPerformer.html#b3">LoadNativeModel</a>(*object, 0);
00075     }
00076     <font class="keywordflow">else</font> {
00077       pfFilePath(FilePath.c_str());
00078       
00079       cout &lt;&lt; <font class="stringliteral">"Loading "</font> &lt;&lt; *object &lt;&lt; <font class="stringliteral">"\n"</font>; 
00080       root = pfdLoadFile((*object).c_str());
00081       <font class="keywordflow">if</font> (root == NULL)
00082         {
00083           pfExit();
00084           exit(-1);
00085         }
00086     }
00087     env-&gt;addChild(root);    
00088   }
00089 }
00090 
00091 
00092 
<a name="l00093"></a><a class="code" href="class_RenderPerformer.html#b2">00093</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b2">RenderPerformer::LoadBodies</a>(pfGroup *bodies)<font class="keyword"></font>{
00094   list&lt;string&gt;::iterator object;
00095   pfNode *root;
00096   <font class="keywordtype">int</font> i;
00097 
00098   i = 0;
00099   <a class="code" href="defs_h.html#a8">forall</a>(object, BodyList)<font class="keyword"> </font>{
00100     <font class="keywordflow">if</font> (!strstr((*object).c_str(),<font class="stringliteral">"."</font>)) {
00101       root = <a class="code" href="class_RenderPerformer.html#b3">LoadNativeModel</a>(*object, i+1);
00102     }
00103     <font class="keywordflow">else</font> {
00104       <font class="comment">// Append to Performer search path</font>
00105       pfFilePath(FilePath.c_str());
00106       
00107       cout &lt;&lt; <font class="stringliteral">"Loading "</font> &lt;&lt; *object &lt;&lt; <font class="stringliteral">"\n"</font>;
00108       root = pfdLoadFile((*object).c_str());
00109       <font class="keywordflow">if</font> (root == NULL)
00110         {
00111           pfExit();
00112           exit(-1);
00113         }
00114     }
00115     pfDCS *piece = <font class="keyword">new</font> pfDCS;
00116     piece-&gt;addChild(root);
00117     bodies-&gt;addChild(piece);    
00118 
00119     i++;
00120   }
00121 }
00122 
00123 
00124 
<a name="l00125"></a><a class="code" href="class_RenderPerformer.html#b3">00125</a> pfNode* <a class="code" href="class_RenderPerformer.html#b3">RenderPerformer::LoadNativeModel</a>(string file, <font class="keywordtype">int</font> colorindex)<font class="keyword">
</font>00126 <font class="keyword"></font>{
00127   pfGeode *root = <font class="keyword">new</font> pfGeode;
00128   pfGeoSet *gset = <font class="keyword">new</font> pfGeoSet;
00129   list&lt;MSLTriangle&gt; trlist;
00130   list&lt;MSLPolygon&gt; plist;
00131   <font class="keywordtype">int</font> i, num;
00132   <font class="keywordtype">double</font> d1[3],d2[3], n[3];
00133   list&lt;MSLTriangle&gt;::iterator t;
00134 
00135   std::ifstream fin((FilePath + file).c_str());
00136   <font class="keywordflow">if</font> (S-&gt;GeomDim == 2) {
00137     fin &gt;&gt; plist;
00138     trlist = <a class="code" href="triangle_h.html#a0">PolygonsToTriangles</a>(plist,5.0); <font class="comment">// Defined in triangle.C</font>
00139   }
00140   <font class="keywordflow">else</font>
00141     fin &gt;&gt; trlist;
00142   fin.close();
00143 
00144   <font class="comment">//cout &lt;&lt; "number of triangles: " &lt;&lt; num &lt;&lt; endl; </font>
00145   num = trlist.size();
00146   pfVec3 *tri = <font class="keyword">new</font> pfVec3[3*num];
00147   pfVec3 *norm = <font class="keyword">new</font> pfVec3[num];
00148   pfVec4 *color = <font class="keyword">new</font> pfVec4[1];
00149 
00150   i = 0;
00151   <a class="code" href="defs_h.html#a8">forall</a> (t,trlist)<font class="keyword"> </font>{
00152     tri[3*i].set((<font class="keywordtype">float</font>) (*t).p1.xcoord(), (<font class="keywordtype">float</font>) (*t).p1.ycoord(), 
00153                  (<font class="keywordtype">float</font>) (*t).p1.zcoord());
00154     tri[3*i+1].set((<font class="keywordtype">float</font>) (*t).p2.xcoord(), (<font class="keywordtype">float</font>) (*t).p2.ycoord(), 
00155                    (<font class="keywordtype">float</font>) (*t).p2.zcoord());
00156     tri[3*i+2].set((<font class="keywordtype">float</font>) (*t).p3.xcoord(), (<font class="keywordtype">float</font>) (*t).p3.ycoord(), 
00157                    (<font class="keywordtype">float</font>) (*t).p3.zcoord());
00158 
00159     d1[0] = (*t).p2.xcoord() - (*t).p1.xcoord();
00160     d1[1] = (*t).p2.ycoord() - (*t).p1.ycoord();
00161     d1[2] = (*t).p2.zcoord() - (*t).p1.zcoord();
00162     d2[0] = (*t).p3.xcoord() - (*t).p1.xcoord();
00163     d2[1] = (*t).p3.ycoord() - (*t).p1.ycoord();
00164     d2[2] = (*t).p3.zcoord() - (*t).p1.zcoord();
00165     <a class="code" href="class_RenderPerformer.html#b10">NormCrossProduct</a>(d1, d2, n);
00166     norm[i].set(n[0], n[1], n[2]);
00167     i++;
00168   }
00169 
00170   color[0].set( RGBRed[colorindex % RENDERCOLORS], 
00171                 RGBGreen[colorindex % RENDERCOLORS], 
00172                 RGBBlue[colorindex % RENDERCOLORS], 0.0f );
00173 
00174   gset-&gt;setAttr(PFGS_COORD3, PFGS_PER_VERTEX, tri, NULL);
00175   gset-&gt;setAttr(PFGS_NORMAL3, PFGS_PER_PRIM, norm, NULL);
00176   gset-&gt;setAttr(PFGS_COLOR4, PFGS_OVERALL, color, NULL);
00177   gset-&gt;setPrimType(PFGS_TRIS);
00178   gset-&gt;setNumPrims(num);
00179 
00180   <font class="comment">//Specify Geometry State</font>
00181   pfGeoState *gstate = <font class="keyword">new</font> pfGeoState;
00182   gstate-&gt;setMode(PFSTATE_ENLIGHTING, PF_ON);
00183   gstate-&gt;setMode(PFSTATE_CULLFACE, PF_OFF);
00184   <font class="comment">//gstate-&gt;setMode(PFSTATE_SHADEMODEL, PFSM_GOURAUD);</font>
00185 
00186   <font class="comment">// Using material</font>
00187   pfMaterial *mat = <font class="keyword">new</font> pfMaterial;
00188   mat-&gt;setColor(PFMTL_AMBIENT, 0.0f, 0.0f, 0.0f);
00189   mat-&gt;setColor(PFMTL_SPECULAR, 0.5f, 0.5f, 0.5f);
00190   mat-&gt;setShininess(10.0f);
00191   mat-&gt;setColorMode(PFMTL_BOTH, PFMTL_CMODE_AD);
00192   <font class="comment">//mat-&gt;apply();</font>
00193 
00194   gstate-&gt;setAttr(PFSTATE_FRONTMTL, mat);
00195   gset-&gt;setGState(gstate);
00196 
00197   <font class="comment">//gset-&gt;setDrawMode(PFGS_FLATSHADE, PF_ON);</font>
00198 
00199   root-&gt;addGSet(gset);
00200   
00201   <font class="keywordflow">return</font> root;
00202 }
00203 
00204 
<a name="l00205"></a><a class="code" href="class_RenderPerformer.html#b4">00205</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b4">RenderPerformer::MakeBoundingBox</a>(pfGeode *bound)<font class="keyword"></font>{
00206   pfGeoSet *gset = <font class="keyword">new</font> pfGeoSet;
00207   pfVec3 *ver = <font class="keyword">new</font> pfVec3[24];
00208   pfVec3 *norm = <font class="keyword">new</font> pfVec3[12];
00209   pfVec4 *color = <font class="keyword">new</font> pfVec4[1];
00210 
00211   ver[0].set(S-&gt;LowerWorld[0], S-&gt;LowerWorld[1], S-&gt;LowerWorld[2]);
00212   ver[1].set(S-&gt;UpperWorld[0], S-&gt;LowerWorld[1], S-&gt;LowerWorld[2]);
00213   norm[0].set(0.0,1.0,0.0);
00214 
00215   ver[2].set(S-&gt;LowerWorld[0], S-&gt;LowerWorld[1], S-&gt;LowerWorld[2]);
00216   ver[3].set(S-&gt;LowerWorld[0], S-&gt;UpperWorld[1], S-&gt;LowerWorld[2]);
00217   norm[1].set(0.0,1.0,0.0);
00218 
00219   ver[4].set(S-&gt;LowerWorld[0], S-&gt;LowerWorld[1], S-&gt;LowerWorld[2]);
00220   ver[5].set(S-&gt;LowerWorld[0], S-&gt;LowerWorld[1], S-&gt;UpperWorld[2]);
00221   norm[2].set(0.0,1.0,0.0);
00222 
00223   ver[6].set(S-&gt;UpperWorld[0], S-&gt;LowerWorld[1], S-&gt;LowerWorld[2]);
00224   ver[7].set(S-&gt;UpperWorld[0], S-&gt;UpperWorld[1], S-&gt;LowerWorld[2]);
00225   norm[3].set(0.0,1.0,0.0);
00226 
00227   ver[8].set(S-&gt;UpperWorld[0], S-&gt;LowerWorld[1], S-&gt;LowerWorld[2]);
00228   ver[9].set(S-&gt;UpperWorld[0], S-&gt;LowerWorld[1], S-&gt;UpperWorld[2]);
00229   norm[4].set(0.0,1.0,0.0);
00230 
00231   ver[10].set(S-&gt;LowerWorld[0], S-&gt;UpperWorld[1], S-&gt;LowerWorld[2]);
00232   ver[11].set(S-&gt;UpperWorld[0], S-&gt;UpperWorld[1], S-&gt;LowerWorld[2]);
00233   norm[5].set(0.0,1.0,0.0);
00234 
00235   ver[12].set(S-&gt;LowerWorld[0], S-&gt;UpperWorld[1], S-&gt;LowerWorld[2]);
00236   ver[13].set(S-&gt;LowerWorld[0], S-&gt;UpperWorld[1], S-&gt;UpperWorld[2]);
00237   norm[6].set(0.0,1.0,0.0);
00238 
00239   ver[14].set(S-&gt;LowerWorld[0], S-&gt;LowerWorld[1], S-&gt;UpperWorld[2]);
00240   ver[15].set(S-&gt;UpperWorld[0], S-&gt;LowerWorld[1], S-&gt;UpperWorld[2]);
00241   norm[7].set(0.0,1.0,0.0);
00242 
00243   ver[16].set(S-&gt;LowerWorld[0], S-&gt;LowerWorld[1], S-&gt;UpperWorld[2]);
00244   ver[17].set(S-&gt;LowerWorld[0], S-&gt;UpperWorld[1], S-&gt;UpperWorld[2]);
00245   norm[8].set(0.0,1.0,0.0);
00246 
00247   ver[18].set(S-&gt;UpperWorld[0], S-&gt;UpperWorld[1], S-&gt;UpperWorld[2]);
00248   ver[19].set(S-&gt;LowerWorld[0], S-&gt;UpperWorld[1], S-&gt;UpperWorld[2]);
00249   norm[9].set(0.0,1.0,0.0);
00250 
00251   ver[20].set(S-&gt;UpperWorld[0], S-&gt;UpperWorld[1], S-&gt;UpperWorld[2]);
00252   ver[21].set(S-&gt;UpperWorld[0], S-&gt;LowerWorld[1], S-&gt;UpperWorld[2]);
00253   norm[10].set(0.0,1.0,0.0);
00254 
00255   ver[22].set(S-&gt;UpperWorld[0], S-&gt;UpperWorld[1], S-&gt;UpperWorld[2]);
00256   ver[23].set(S-&gt;UpperWorld[0], S-&gt;UpperWorld[1], S-&gt;LowerWorld[2]);
00257   norm[11].set(0.0,1.0,0.0);
00258 
00259   color[0].set( 1, 0, 0, 0.0f );
00260 
00261   gset-&gt;setAttr(PFGS_COORD3, PFGS_PER_VERTEX, ver, NULL);
00262   gset-&gt;setAttr(PFGS_NORMAL3, PFGS_PER_PRIM, norm, NULL);
00263   gset-&gt;setAttr(PFGS_COLOR4, PFGS_OVERALL, color, NULL);
00264   gset-&gt;setPrimType(PFGS_LINES);
00265   gset-&gt;setNumPrims(12);
00266 
00267   <font class="comment">//Specify Geometry State</font>
00268   pfGeoState *gstate = <font class="keyword">new</font> pfGeoState;
00269   gstate-&gt;setMode(PFSTATE_ENLIGHTING, PF_ON);
00270   gstate-&gt;setMode(PFSTATE_CULLFACE, PF_OFF);
00271   <font class="comment">//gstate-&gt;setMode(PFSTATE_SHADEMODEL, PFSM_GOURAUD);</font>
00272 
00273   <font class="comment">// Using material</font>
00274   pfMaterial *mat = <font class="keyword">new</font> pfMaterial;
00275   mat-&gt;setColor(PFMTL_AMBIENT, 0.0f, 0.0f, 0.0f);
00276   mat-&gt;setColor(PFMTL_SPECULAR, 0.5f, 0.5f, 0.5f);
00277   mat-&gt;setShininess(10.0f);
00278   mat-&gt;setColorMode(PFMTL_BOTH, PFMTL_CMODE_AD);
00279   gstate-&gt;setAttr(PFSTATE_FRONTMTL, mat);
00280  
00281   gset-&gt;setGState(gstate);
00282 
00283   bound-&gt;addGSet(gset);
00284 }
00285 
00286 
00287 
<a name="l00288"></a><a class="code" href="class_RenderPerformer.html#b5">00288</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b5">RenderPerformer::MakeControlPanel</a>(pfGroup *con, pfDCS *pad)<font class="keyword"></font>{
00289   pfGeode *geopad = <font class="keyword">new</font> pfGeode;
00290   pfGeode *geo = <font class="keyword">new</font> pfGeode;
00291   pfGeoSet *gset_frame = <font class="keyword">new</font> pfGeoSet;
00292   pfGeoSet *gset_pad = <font class="keyword">new</font> pfGeoSet;
00293 
00294   <font class="comment">//Specify Geometry State</font>
00295   pfGeoState *gstate = <font class="keyword">new</font> pfGeoState;
00296   gstate-&gt;setMode(PFSTATE_TRANSPARENCY, PFTR_ON);
00297   gstate-&gt;setMode(PFSTATE_ENLIGHTING, PF_ON);
00298   gstate-&gt;setMode(PFSTATE_CULLFACE, PF_OFF);
00299 
00300   <font class="comment">// Using material</font>
00301   pfMaterial *mat = <font class="keyword">new</font> pfMaterial;
00302   mat-&gt;setColor(PFMTL_AMBIENT, 0.0f, 0.0f, 0.0f);
00303   mat-&gt;setColor(PFMTL_SPECULAR, 0.5f, 0.5f, 0.5f);
00304   mat-&gt;setShininess(10.0f);
00305   mat-&gt;setColorMode(PFMTL_BOTH, PFMTL_CMODE_AD);
00306   gstate-&gt;setAttr(PFSTATE_FRONTMTL, mat);
00307 
00308   pfVec3 *tri = <font class="keyword">new</font> pfVec3[4];
00309   pfVec3 *norm = <font class="keyword">new</font> pfVec3[1];
00310   pfVec4 *color = <font class="keyword">new</font> pfVec4[1];
00311 
00312   tri[0].set(-CONTROLPANEL_BAR_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00313              -CONTROLPANEL_BAR_HEIGHT + CONTROLPANEL_CENTER_Z);
00314   tri[1].set(-CONTROLPANEL_BAR_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00315              CONTROLPANEL_BAR_HEIGHT + CONTROLPANEL_CENTER_Z);
00316   tri[2].set(CONTROLPANEL_BAR_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00317              CONTROLPANEL_BAR_HEIGHT + CONTROLPANEL_CENTER_Z);
00318   tri[3].set(CONTROLPANEL_BAR_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00319              -CONTROLPANEL_BAR_HEIGHT + CONTROLPANEL_CENTER_Z);
00320   norm[0].set(0.0, -1.0, 0.0);
00321   color[0].set(0.5, 0.5, 1.0, 0.5f );
00322 
00323   gset_frame-&gt;setAttr(PFGS_COORD3, PFGS_PER_VERTEX, tri, NULL);
00324   gset_frame-&gt;setAttr(PFGS_NORMAL3, PFGS_PER_PRIM, norm, NULL);
00325   gset_frame-&gt;setAttr(PFGS_COLOR4, PFGS_PER_PRIM, color, NULL);
00326   gset_frame-&gt;setPrimType(PFGS_QUADS);
00327   gset_frame-&gt;setNumPrims(1);
00328   gset_frame-&gt;setGState(gstate);
00329   geo-&gt;addGSet(gset_frame);
00330 
00331   con-&gt;addChild(geo);
00332 
00333   <font class="comment">// Draw Control Pad</font>
00334   pfVec3 *tri1 = <font class="keyword">new</font> pfVec3[4];
00335   pfVec3 *norm1 = <font class="keyword">new</font> pfVec3[1];
00336   pfVec4 *color1 = <font class="keyword">new</font> pfVec4[1];
00337 
00338   tri1[0].set(-CONTROLPAD_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00339               -CONTROLPAD_HEIGHT + CONTROLPANEL_CENTER_Z);
00340   tri1[1].set(-CONTROLPAD_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00341               CONTROLPAD_HEIGHT + CONTROLPANEL_CENTER_Z);
00342   tri1[2].set(CONTROLPAD_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00343               CONTROLPAD_HEIGHT + CONTROLPANEL_CENTER_Z);
00344   tri1[3].set(CONTROLPAD_WIDTH + CONTROLPANEL_CENTER_X, -299.0,
00345               -CONTROLPAD_HEIGHT + CONTROLPANEL_CENTER_Z);
00346   norm1[0].set(0.0, -1.0, 0.0);
00347   color1[0].set(0.0, 0.0, 1.0, 0.5);
00348 
00349   gset_pad-&gt;setAttr(PFGS_COORD3, PFGS_PER_VERTEX, tri1, NULL);
00350   gset_pad-&gt;setAttr(PFGS_NORMAL3, PFGS_PER_PRIM, norm1, NULL);
00351   gset_pad-&gt;setAttr(PFGS_COLOR4, PFGS_PER_PRIM, color1, NULL);
00352   gset_pad-&gt;setPrimType(PFGS_QUADS);
00353   gset_pad-&gt;setNumPrims(1);
00354   gset_pad-&gt;setGState(gstate);
00355   geopad-&gt;addGSet(gset_pad);
00356   
00357   pad-&gt;addChild(geopad);
00358 }
00359 
00360 
00361 
00362 
00363 
<a name="l00364"></a><a class="code" href="class_RenderPerformer.html#b10">00364</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b10">RenderPerformer::NormCrossProduct</a>(<font class="keywordtype">double</font> v1[3], <font class="keywordtype">double</font> v2[3], 
00365                                        <font class="keywordtype">double</font> out[3])<font class="keyword"> </font>{
00366   out[0] = v1[1]*v2[2] - v1[2]*v2[1];
00367   out[1] = v1[2]*v2[0] - v1[0]*v2[2];
00368   out[2] = v1[0]*v2[1] - v1[1]*v2[0];
00369 
00370   GLfloat d = sqrt(out[0]*out[0] + out[1]*out[1] + out[2]*out[2]);
00371 
00372   out[0] /= d;
00373   out[1] /= d;
00374   out[2] /= d;
00375 }
00376 
00377 
00378 
<a name="l00379"></a><a class="code" href="class_RenderPerformer.html#b6">00379</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b6">RenderPerformer::GetCurrentMousePos</a>(<font class="keywordtype">double</font> &amp;x, <font class="keywordtype">double</font> &amp;y)<font class="keyword"></font>{
00380   pfuGetMouse(Shared-&gt;Mouse);
00381   pfuMapMouseToChan(Shared-&gt;Mouse, Shared-&gt;Chan); <font class="comment">// no matter mouse in chan or not return a value</font>
00382   x = (<font class="keywordtype">double</font>)Shared-&gt;Mouse-&gt;xchan;
00383   y = (<font class="keywordtype">double</font>)Shared-&gt;Mouse-&gt;ychan;
00384 
00385   <font class="keywordflow">switch</font>(Shared-&gt;Mouse-&gt;click){
00386   <font class="keywordflow">case</font> 1: <font class="comment">// click right</font>
00387     Shared-&gt;HoldRightMouse = <font class="keyword">true</font>;
00388     <font class="keywordflow">break</font>;
00389   <font class="keywordflow">case</font> 2: <font class="comment">// click  middle</font>
00390     Shared-&gt;HoldMiddleMouse = <font class="keyword">true</font>;
00391     <font class="keywordflow">break</font>;
00392   <font class="keywordflow">case</font> 4: <font class="comment">// click left</font>
00393     Shared-&gt;HoldLeftMouse = <font class="keyword">true</font>;
00394     <font class="keywordflow">break</font>;
00395   <font class="keywordflow">default</font>: <font class="comment">// none</font>
00396     <font class="keywordflow">break</font>;
00397   }
00398   
00399   <font class="keywordflow">switch</font>(Shared-&gt;Mouse-&gt;release){
00400   <font class="keywordflow">case</font> 5: <font class="comment">// release right and left</font>
00401     Shared-&gt;HoldRightMouse = <font class="keyword">false</font>;
00402     Shared-&gt;HoldLeftMouse = <font class="keyword">false</font>;
00403     <font class="keywordflow">break</font>;
00404   <font class="keywordflow">case</font> 7: <font class="comment">// release middle;</font>
00405     Shared-&gt;HoldMiddleMouse = <font class="keyword">false</font>;
00406     <font class="keywordflow">break</font>;
00407   <font class="keywordflow">default</font>: <font class="comment">// none</font>
00408     <font class="keywordflow">break</font>;
00409   }     
00410 }
00411 
00412 
<a name="l00413"></a><a class="code" href="class_RenderPerformer.html#b0">00413</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b0">RenderPerformer::ShowCurrentAnimationFrame</a>()<font class="keyword"> </font>{
00414   <font class="keywordtype">int</font> i,j;
00415   <a class="code" href="class_MSLVector.html">MSLVector</a> conf(6),oldframe;
00416   pfMatrix orientation, rot, delta_rot;
00417 
00418   <font class="keywordflow">if</font> (AnimationActive)
00419     <a class="code" href="class_Render.html#b0">SetCurrentAnimationFrame</a>();
00420   
00421   <font class="comment">// Show the bodies in their proper places</font>
00422   <font class="keywordflow">for</font> (i = 0; i &lt; S-&gt;NumBodies; i++) {
00423     <font class="comment">// for each robot, first read its own configuration from FrameList</font>
00424     <font class="keywordflow">for</font> (j = 0; j &lt; 6; j++)
00425       conf[j] = CurrentAnimationFrame[6*i+j];
00426     
00427     <font class="comment">// update coordinate system</font>
00428     orientation.makeIdent();
00429     rot.makeIdent();
00430     <font class="comment">// rotate x</font>
00431     delta_rot.makeRot(conf[3]*180.0/PI, 1.0, 0.0, 0.0);
00432     rot.postMult(delta_rot);
00433     <font class="comment">// rotate y</font>
00434     delta_rot.makeRot(conf[4]*180.0/PI, 0.0, 1.0, 0.0);
00435     rot.postMult(delta_rot);
00436     <font class="comment">// rotate Z</font>
00437     delta_rot.makeRot(conf[5]*180.0/PI, 0.0, 0.0, 1.0);
00438     rot.postMult(delta_rot);
00439     
00440     <font class="comment">// Translate</font>
00441     orientation.postTrans(rot, conf[0], conf[1], conf[2]);
00442     
00443     pfDCS *child_robot = pfGetChild(Shared-&gt;BodiesDCS, i);
00444     child_robot-&gt;setMat(orientation);
00445   }
00446 }
00447   
00448 
<a name="l00449"></a><a class="code" href="class_RenderPerformer.html#a4">00449</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#a4">RenderPerformer::Init</a>()<font class="keyword"> </font>{
00450   <a class="code" href="class_Render.html#a4">Render::Init</a>();
00451 
00452   <font class="comment">// Initialize Performer</font>
00453   pfInit();
00454     
00455   <font class="comment">// Use default multiprocessing mode based on number of processors.</font>
00456   pfMultiprocess( PFMP_DEFAULT );
00457 
00458   <font class="comment">// allocate shared before fork()'ing parallel processes  </font>
00459   Shared = (SharedData*)pfMalloc(<font class="keyword">sizeof</font>(SharedData), pfGetSharedArena());
00460  
00461   <font class="comment">// Set Performer Search Path</font>
00462   pfFilePath(FilePath.c_str());
00463 
00464   <font class="comment">// Load all loader DSO's before pfConfig() forks </font>
00465   list&lt;string&gt;::iterator object;
00466 
00467   <a class="code" href="defs_h.html#a8">forall</a>(object, EnvList)<font class="keyword"> </font>{
00468     <font class="keywordflow">if</font>( strstr((*object).c_str(),<font class="stringliteral">"."</font>) ) 
00469       pfdInitConverter((*object).c_str());
00470   }
00471 
00472   <a class="code" href="defs_h.html#a8">forall</a>(object, BodyList)<font class="keyword"> </font>{
00473     <font class="keywordflow">if</font>( strstr((*object).c_str(),<font class="stringliteral">"."</font>) )
00474       pfdInitConverter((*object).c_str());
00475   }
00476 
00477   <font class="comment">// initiate multi-processing mode set in pfMultiprocess call </font>
00478   <font class="comment">// FORKs for Performer processes,  CULL and DRAW, etc. happen here.</font>
00479   pfConfig();                   
00480   
00481   <font class="comment">// Initiate performer utility library</font>
00482   pfuInit();
00483 
00484   <font class="comment">// Create Mouse and InputEvents</font>
00485   Shared-&gt;Mouse = <font class="keyword">new</font> pfuMouse;
00486   Shared-&gt;InputEvents = <font class="keyword">new</font> pfuEventStream;
00487     
00488   <font class="comment">// Create a new pfScene</font>
00489   pfScene *PerfScene = <font class="keyword">new</font> pfScene;
00490 
00491   <font class="comment">// Load Environment and attach it to scene</font>
00492   Shared-&gt;ShowCase = <font class="keyword">new</font> pfSwitch;
00493   Shared-&gt;ControlPanel = <font class="keyword">new</font> pfGroup;
00494   Shared-&gt;ControlPad = <font class="keyword">new</font> pfDCS;
00495   Shared-&gt;WorldDCS = <font class="keyword">new</font> pfDCS;
00496   Shared-&gt;WorkEnv = <font class="keyword">new</font> pfSwitch;
00497   Shared-&gt;Env = <font class="keyword">new</font> pfGroup;
00498   Shared-&gt;BodiesDCS = <font class="keyword">new</font> pfDCS;
00499   Shared-&gt;BoundingBox = <font class="keyword">new</font> pfGeode;
00500 
00501   <a class="code" href="class_RenderPerformer.html#b1">LoadEnvironment</a>(Shared-&gt;Env);
00502   <a class="code" href="class_RenderPerformer.html#b2">LoadBodies</a>(Shared-&gt;BodiesDCS);
00503 
00504   <a class="code" href="class_RenderPerformer.html#b4">MakeBoundingBox</a>(Shared-&gt;BoundingBox);
00505   <a class="code" href="class_RenderPerformer.html#b5">MakeControlPanel</a>(Shared-&gt;ControlPanel, Shared-&gt;ControlPad);
00506 
00507   Shared-&gt;ControlPanel-&gt;addChild(Shared-&gt;ControlPad);
00508   Shared-&gt;WorkEnv-&gt;addChild(Shared-&gt;Env);
00509   Shared-&gt;WorkEnv-&gt;addChild(Shared-&gt;BoundingBox);
00510   Shared-&gt;WorldDCS-&gt;addChild(Shared-&gt;WorkEnv);
00511   Shared-&gt;WorldDCS-&gt;addChild(Shared-&gt;BodiesDCS);
00512   Shared-&gt;ShowCase-&gt;addChild(Shared-&gt;WorldDCS);
00513   Shared-&gt;ShowCase-&gt;addChild(Shared-&gt;ControlPanel);  
00514   PerfScene-&gt;addChild(Shared-&gt;ShowCase);
00515 
00516   <font class="comment">// Create a pfLightSource</font>
00517   pfLightSource *sun = <font class="keyword">new</font> pfLightSource;
00518   sun-&gt;setPos(-100.0, -100.0, 100.0, 1.0);
00519   PerfScene-&gt;addChild(sun);
00520   pfLightSource *sun2 = <font class="keyword">new</font> pfLightSource;
00521   sun2-&gt;setPos(0.0, 0.0, 0.0, 0.0);
00522 
00523   <font class="comment">// Uncomment the next line to make things brighter</font>
00524   <font class="comment">//sun2-&gt;setAmbient(1.0, 1.0, 1.0);</font>
00525 
00526   PerfScene-&gt;addChild(sun2);
00527 
00528   <font class="comment">// Configure and open GL window</font>
00529   pfPipe *Pipe = pfGetPipe(0);
00530   Shared-&gt;PW = <font class="keyword">new</font> pfPipeWindow(Pipe);
00531   Shared-&gt;PW-&gt;setWinType(PFPWIN_TYPE_X);
00532   Shared-&gt;PW-&gt;setName(<font class="stringliteral">"MSL Render: IRIS Performer Window"</font>);
00533   Shared-&gt;PW-&gt;setOriginSize(0,0,500,500);
00534   Shared-&gt;PW-&gt;open();
00535   
00536   <font class="comment">// Create and configure a pfChannel.</font>
00537   pfChannel *chan = <font class="keyword">new</font> pfChannel(Pipe);
00538   chan-&gt;setScene(PerfScene);
00539   chan-&gt;setFOV(45.0f, 45.0f);
00540   chan-&gt;setNearFar(1.0f, 1000.0f);
00541   chan-&gt;setTravFunc(PFTRAV_DRAW, DrawChannel);
00542   chan-&gt;setViewport(0.0, 1.0, 0, 1.0);
00543   chan-&gt;setShare(PFCHAN_FOV | PFCHAN_NEARFAR
00544                  | PFCHAN_EARTHSKY 
00545                  | PFCHAN_STRESS 
00546                  | PFCHAN_LOD | PFCHAN_SWAPBUFFERS
00547                  | PFCHAN_SWAPBUFFERS_HW);
00548 
00549   Shared-&gt;Chan = chan;
00550   <font class="comment">// Set Chan view point  </font>
00551   <font class="comment">// Unfortunately, this viewing transformation has to be fixed,</font>
00552   <font class="comment">// otherwise the control panel will disappear because of the </font>
00553   <font class="comment">// way it was designed.</font>
00554   pfCoord view;
00555   view.hpr.set(0.0, 0.0, 0.0); <font class="comment">// z,x,y</font>
00556   view.xyz.set(0.0, -300.0, 0.0);
00557   Shared-&gt;Chan-&gt;setView(view.xyz, view.hpr);
00558 
00559   pfEarthSky *esky = <font class="keyword">new</font> pfEarthSky();
00560   esky-&gt;setMode(PFES_BUFFER_CLEAR, PFES_SKY_GRND);
00561   esky-&gt;setAttr(PFES_GRND_HT, -1000.0f);
00562   esky-&gt;setColor(PFES_GRND_FAR, 0.3f, 0.1f, 0.0f, 1.0f);
00563   esky-&gt;setColor(PFES_GRND_NEAR, 0.5f, 0.3f, 0.1f, 1.0f);
00564   chan-&gt;setESky(esky);
00565 
00566   <font class="comment">// Initilize the slave channel</font>
00567   <font class="comment">/*pfChannel *chaneye = new pfChannel(Pipe);
</font>00568 <font class="comment">  pfScene *eyescene = new pfScene;
</font>00569 <font class="comment">  pfMatrix m;
</font>00570 <font class="comment">  m.makeIdent();
</font>00571 <font class="comment">  pfSCS *eyeworld = new pfSCS(m); 
</font>00572 <font class="comment">  
</font>00573 <font class="comment">  eyeworld-&gt;addChild(Shared-&gt;EnvDCS);
</font>00574 <font class="comment">  eyeworld-&gt;addChild(Shared-&gt;BodiesDCS);
</font>00575 <font class="comment">  eyescene-&gt;addChild(eyeworld);
</font>00576 <font class="comment">
</font>00577 <font class="comment">  chaneye-&gt;setScene(eyescene);
</font>00578 <font class="comment">  chan-&gt;attach(chaneye);
</font>00579 <font class="comment">  chaneye-&gt;setViewport(0.0, 1.0/4.0, 3.0/4.0, 1.0);
</font>00580 <font class="comment">  Shared-&gt;ChanEye = chaneye;
</font>00581 <font class="comment">  PW-&gt;removeChan(ChanEye); // remove chanslaver as default
</font>00582 <font class="comment">  */</font>
00583 
00584   <font class="comment">// Initilize input device</font>
00585   pfuInitInput(Shared-&gt;PW,PFUINPUT_X);
00586 
00587   <font class="comment">// Get frame rate and set it to FrameTime</font>
00588   FrameTime = (<font class="keywordtype">double</font>) 0.1; <font class="comment">// (1.0/pfGetFrameRate());</font>
00589   <font class="comment">//cout &lt;&lt; "FrameTime: " &lt;&lt; FrameTime &lt;&lt; endl;</font>
00590 
00591   Shared-&gt;HoldRightMouse = <font class="keyword">false</font>;
00592   Shared-&gt;HoldLeftMouse = <font class="keyword">false</font>;
00593   Shared-&gt;HoldMiddleMouse = <font class="keyword">false</font>;
00594   <font class="comment">//Shared-&gt;ReleaseRightMouse = false;</font>
00595   <font class="comment">//Shared-&gt;ReleaseLeftMouse = false;</font>
00596   <font class="comment">//Shared-&gt;ReleaseMiddleMouse = false;</font>
00597 
00598   <font class="comment">// Here is where we have to make the initial values correspond</font>
00599   <font class="comment">// to what the viewing parameters from Scene dictate.</font>
00600   Shared-&gt;TranX = 0.0;
00601   Shared-&gt;TranY = 0.0;
00602   Shared-&gt;TranZ = 0.0;
00603   Shared-&gt;RotX = 0.0;
00604   Shared-&gt;RotY = 0.0;
00605   Shared-&gt;RotZ = 0.0;
00606 
00607   <font class="comment">//Set boundbox</font>
00608   BoundingBoxOn = <font class="keyword">false</font>;
00609 
00610   <font class="comment">// By default, don't use attached camera</font>
00611   AttachedCameraOn = <font class="keyword">false</font>;
00612   
00613   <font class="comment">// Set control pannel initial pos</font>
00614   Shared-&gt;ControlPanelOn = <font class="keyword">true</font>;
00615   Shared-&gt;FocusOnControlPad = <font class="keyword">false</font>;
00616   Shared-&gt;PadX = 0.0;
00617   Shared-&gt;ControlPad-&gt;setTrans(Shared-&gt;PadX, 0.0, 0.0);
00618 
00619   <font class="comment">// Make Eye initial matrix</font>
00620   pfMatrix delta_rot;
00621   Shared-&gt;EyeMat.makeIdent();
00622   <font class="comment">// rotate along Z 90 degrees</font>
00623   delta_rot.makeRot(-90.0, 0.0, 0.0, 1.0);
00624   Shared-&gt;EyeMat.postMult(delta_rot);
00625   <font class="comment">// Translate to designed position</font>
00626   delta_rot.makeTrans(10, 10, 0);
00627   Shared-&gt;EyeMat.postMult(delta_rot);
00628 
00629   <font class="comment">// Get courrent mouse position</font>
00630   <a class="code" href="class_RenderPerformer.html#b6">GetCurrentMousePos</a>(Shared-&gt;MouseXOld, Shared-&gt;MouseYOld);
00631 }
00632 
00633 
00634 
<a name="l00635"></a><a class="code" href="class_RenderPerformer.html#a6">00635</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#a6">RenderPerformer::Terminate</a>()<font class="keyword"></font>{
00636   <font class="comment">// Terminate parallel processes and exit</font>
00637   pfuExitInput();
00638   pfExit();
00639 }
00640 
00641 
00642 
<a name="l00643"></a><a class="code" href="class_RenderPerformer.html#b7">00643</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b7">RenderPerformer::HandleKeyInput</a>()<font class="keyword"></font>{
00644   <font class="keywordtype">int</font> inkey;
00645 
00646   pfuGetEvents(Shared-&gt;InputEvents);
00647 
00648   <font class="keywordflow">if</font> (Shared-&gt;InputEvents-&gt;numKeys &gt; 0) {
00649     inkey = Shared-&gt;InputEvents-&gt;keyQ[0];
00650     pfuResetEventStream(Shared-&gt;InputEvents);
00651     <font class="comment">//cout &lt;&lt; inkey &lt;&lt; endl;</font>
00652 
00653     <font class="keywordflow">switch</font>(inkey){
00654     <font class="keywordflow">case</font> <font class="charliteral">'b'</font> : 
00655       BoundingBoxOn = !BoundingBoxOn;  <font class="comment">// Toggle</font>
00656       <font class="keywordflow">break</font>;
00657     <font class="keywordflow">case</font> <font class="charliteral">'c'</font> :
00658       Shared-&gt;ControlPanelOn = !Shared-&gt;ControlPanelOn;  <font class="comment">// Toggle</font>
00659       <font class="keywordflow">break</font>;
00660     <font class="keywordflow">case</font> <font class="charliteral">'v'</font> :
00661       AttachedCameraOn = !AttachedCameraOn;  <font class="comment">// Toggle</font>
00662       <font class="keywordflow">break</font>;
00663     }
00664   }
00665 }
00666 
00667 
00668 
<a name="l00669"></a><a class="code" href="class_RenderPerformer.html#b9">00669</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b9">RenderPerformer::GetControlPadSize</a>(<font class="keywordtype">double</font> &amp;padwidth_l, 
00670                                         <font class="keywordtype">double</font> &amp;padwidth_r, 
00671                                         <font class="keywordtype">double</font> &amp;padheight_b, 
00672                                         <font class="keywordtype">double</font> &amp;padheight_top)<font class="keyword"></font>{
00673 
00674   padwidth_l = (CONTROLPANEL_CENTER_X + 
00675                 Shared-&gt;PadX - CONTROLPAD_WIDTH)/tan(22.5*PI/180.0);
00676   padwidth_r = (CONTROLPANEL_CENTER_X + 
00677                 Shared-&gt;PadX + CONTROLPAD_WIDTH)/tan(22.5*PI/180.0);
00678   padheight_b = (CONTROLPANEL_CENTER_Z - 
00679                  CONTROLPAD_HEIGHT)/tan(22.5*PI/180.0);
00680   padheight_top = (CONTROLPANEL_CENTER_Z + 
00681                    CONTROLPAD_HEIGHT)/tan(22.5*PI/180.0);
00682 
00683 }
00684 
00685 
00686 
<a name="l00687"></a><a class="code" href="class_RenderPerformer.html#b8">00687</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#b8">RenderPerformer::HandleMouseEvents</a>()<font class="keyword"> </font>{
00688   <font class="keywordtype">double</font> mousex_new, mousey_new, theta;
00689   pfMatrix transform, dtransform;
00690   <font class="keywordtype">double</font> padw_l, padw_r, padh_b, padh_top;
00691   <a class="code" href="class_MSLVector.html">MSLVector</a> vp,vd;
00692   <font class="keywordtype">double</font> vo;
00693   <font class="keywordtype">int</font> i,j,k;
00694   <a class="code" href="class_MSLVector.html">MSLVector</a> c,conf(6);
00695   list&lt;MSLVector&gt;::iterator fi;
00696 
00697   <font class="comment">// Get control pad size</font>
00698   <a class="code" href="class_RenderPerformer.html#b9">GetControlPadSize</a>(padw_l, padw_r, padh_b, padh_top);
00699 
00700   <font class="comment">// Get current mouse position</font>
00701   <a class="code" href="class_RenderPerformer.html#b6">GetCurrentMousePos</a>(mousex_new, mousey_new);
00702 
00703   <font class="comment">// If mouse is inside the pad and ControlPanelOn is true</font>
00704   <font class="comment">// deal with control pannel</font>
00705   <font class="keywordflow">if</font>( Shared-&gt;MouseXOld &gt;= padw_l
00706       &amp;&amp; Shared-&gt;MouseXOld &lt;= padw_r
00707       &amp;&amp; Shared-&gt;MouseYOld &gt;= padh_b
00708       &amp;&amp; Shared-&gt;MouseYOld &lt;= padh_top
00709       &amp;&amp; Shared-&gt;HoldLeftMouse
00710       &amp;&amp; Shared-&gt;ControlPanelOn ){
00711     Shared-&gt;FocusOnControlPad = <font class="keyword">true</font>;    
00712   }
00713   <font class="keywordflow">if</font>(!Shared-&gt;HoldLeftMouse)
00714     Shared-&gt;FocusOnControlPad = <font class="keyword">false</font>;; 
00715 
00716   <font class="keywordflow">if</font>(Shared-&gt;FocusOnControlPad){
00717     Shared-&gt;PadX = Shared-&gt;PadX + 0.3*(mousex_new - Shared-&gt;MouseXOld);
00718     <font class="keywordflow">if</font>(Shared-&gt;PadX &gt;= CONTROLPANEL_BAR_WIDTH)
00719       Shared-&gt;PadX = CONTROLPANEL_BAR_WIDTH;
00720     <font class="keywordflow">else</font>
00721       <font class="keywordflow">if</font>(Shared-&gt;PadX &lt;= -CONTROLPANEL_BAR_WIDTH)
00722         Shared-&gt;PadX = -CONTROLPANEL_BAR_WIDTH;
00723 
00724     <font class="comment">// Range of speeds: 2^-ANIMATING_SPEED_FACTOR to 2^ANIMATING_SPEED_FACTOR</font>
00725     AnimationTimeScale = pow(2.0,ANIMATING_SPEED_FACTOR *
00726                              Shared-&gt;PadX/CONTROLPANEL_BAR_WIDTH);
00727 
00728     Shared-&gt;ControlPad-&gt;setTrans(Shared-&gt;PadX, 0.0, 0.0);    
00729   }
00730 
00731   <font class="comment">// else set global orientation</font>
00732   <font class="keywordflow">if</font>( !Shared-&gt;FocusOnControlPad &amp;&amp; Shared-&gt;HoldRightMouse ) {
00733     <font class="keywordflow">if</font>(fabs(Shared-&gt;MouseXOld - mousex_new) &gt; 0.00001)
00734       Shared-&gt;RotY += 40*(mousex_new - Shared-&gt;MouseXOld);
00735     <font class="keywordflow">if</font>(fabs(Shared-&gt;MouseYOld - mousey_new) &gt; 0.00001) {
00736       Shared-&gt;TranY += 60*(mousey_new - Shared-&gt;MouseYOld);
00737     }
00738   }
00739   
00740   <font class="keywordflow">if</font>( !Shared-&gt;FocusOnControlPad &amp;&amp; Shared-&gt;HoldLeftMouse ){
00741     <font class="keywordflow">if</font>(fabs(Shared-&gt;MouseXOld - mousex_new) &gt; 0.00001)
00742       Shared-&gt;RotZ -= 40*(Shared-&gt;MouseXOld - mousex_new);
00743     <font class="keywordflow">if</font>(fabs(Shared-&gt;MouseYOld - mousey_new) &gt; 0.00001)
00744       Shared-&gt;RotX += 40*(Shared-&gt;MouseYOld - mousey_new);
00745   }
00746 
00747   <font class="keywordflow">if</font>( !Shared-&gt;FocusOnControlPad &amp;&amp; Shared-&gt;HoldMiddleMouse ){
00748     <font class="keywordflow">if</font>(fabs(Shared-&gt;MouseXOld - mousex_new) &gt; 0.00001)
00749       Shared-&gt;TranX += 60*(mousex_new - Shared-&gt;MouseXOld);
00750     <font class="keywordflow">if</font>(fabs(Shared-&gt;MouseYOld - mousey_new) &gt; 0.00001)
00751       Shared-&gt;TranZ += 60*(mousey_new - Shared-&gt;MouseYOld);
00752   }
00753 
00754 
00755   <font class="comment">// Compute the global transformation matrix</font>
00756 
00757   <font class="comment">// Start with identity</font>
00758   transform.makeIdent();
00759 
00760   <font class="comment">// Determine where to take the viewing transformations from</font>
00761   <font class="keywordflow">if</font> (AttachedCameraOn) {
00762     k = AnimationFrameIndex;
00763     fi = FrameList.begin();
00764     <font class="keywordflow">for</font> (i = 0; i &lt; (<font class="keywordtype">int</font>) FrameList.size(); i++)
00765       fi++;
00766     c = *fi;
00767     <font class="keywordflow">for</font> (j = 0; j &lt; 6; j++)
00768       conf[j] = c[ 6 * S-&gt;AttachedCameraBody + j];
00769 
00770     vp = S-&gt;AttachedCameraPosition;
00771     vd = S-&gt;AttachedCameraDirection;
00772     vo = 0.0;  <font class="comment">// THIS NEEDS TO BE COMPUTED FROM AttachedCameraZenith</font>
00773 
00774     <font class="comment">// Transform the camera according to the attached body</font>
00775     dtransform.makeTrans(-conf[0], -conf[1], -conf[2]);
00776     transform.postMult(dtransform);
00777 
00778     dtransform.makeRot(-conf[5]*180.0/PI, 0.0, 0.0, 1.0);
00779     transform.postMult(dtransform);
00780 
00781     dtransform.makeRot(-conf[4]*180.0/PI, 0.0, 1.0, 0.0);
00782     transform.postMult(dtransform);
00783 
00784     dtransform.makeRot(-conf[3]*180.0/PI, 1.0, 0.0, 0.0);
00785     transform.postMult(dtransform);
00786   }
00787   <font class="keywordflow">else</font> {
00788     vp = S-&gt;GlobalCameraPosition;
00789     vd = S-&gt;GlobalCameraDirection;
00790     vo = 0.0;  <font class="comment">// THIS NEEDS TO BE COMPUTED FROM GlobalCameraZenith</font>
00791   }
00792 
00793   <font class="comment">// Set up the viewing direction</font>
00794   dtransform.makeTrans(-vp[0], -vp[1], -vp[2]);
00795   transform.postMult(dtransform);
00796 
00797   dtransform.makeRot(-vo*180.0/PI, vd[0], vd[1], vd[2]);
00798   transform.postMult(dtransform);
00799 
00800   theta = -asin(sqrt(<a class="code" href="defs_h.html#a2">sqr</a>(vd[0]) + <a class="code" href="defs_h.html#a2">sqr</a>(vd[2])));
00801   dtransform.makeRot(theta*180.0/PI, vd[2], 0.0, -vd[0]);
00802   transform.postMult(dtransform);
00803 
00804   <font class="comment">// Handle the translation generated by the user</font>
00805   dtransform.makeTrans(Shared-&gt;TranX, Shared-&gt;TranY, Shared-&gt;TranZ);
00806   transform.postMult(dtransform);
00807 
00808   <font class="comment">// Undo the forced channel viewpoint</font>
00809   dtransform.makeTrans(0.0, -300.0, 0.0);
00810   transform.postMult(dtransform);
00811 
00812   <font class="comment">// Handle the rotation generated by the user</font>
00813   dtransform.makeRot(Shared-&gt;RotZ, 0.0, 0.0, 1.0);
00814   transform.postMult(dtransform);
00815   dtransform.makeRot(Shared-&gt;RotY, 0.0, 1.0, 0.0);
00816   transform.postMult(dtransform);
00817   dtransform.makeRot(Shared-&gt;RotX, 1.0, 0.0, 0.0);
00818   transform.postMult(dtransform);
00819 
00820   <font class="comment">// Set the transformation</font>
00821   Shared-&gt;WorldDCS-&gt;setMat(transform);
00822   
00823   <font class="comment">//Update old mouse position</font>
00824   Shared-&gt;MouseXOld = mousex_new;
00825   Shared-&gt;MouseYOld = mousey_new;
00826 }
00827 
00828 
00829 
<a name="l00830"></a><a class="code" href="class_RenderPerformer.html#a5">00830</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#a5">RenderPerformer::HandleEvents</a>()<font class="keyword"> </font>{
00831   <font class="comment">// Handle events from render control window</font>
00832   <a class="code" href="class_Render.html#a5">Render::HandleEvents</a>();
00833 
00834   <font class="comment">// Go to sleep until next frame time.</font>
00835   pfSync();             
00836   
00837   <font class="comment">//Collect key input events</font>
00838   <a class="code" href="class_RenderPerformer.html#b7">HandleKeyInput</a>();
00839  
00840   <font class="comment">// handle Mouse events</font>
00841   <a class="code" href="class_RenderPerformer.html#b8">HandleMouseEvents</a>();
00842 
00843   <font class="comment">// setup body animating</font>
00844   <font class="keywordflow">if</font> (AnimationActive) {
00845     <a class="code" href="class_RenderPerformer.html#b0">ShowCurrentAnimationFrame</a>();
00846   }
00847 
00848   <font class="comment">// Always display world</font>
00849   Shared-&gt;WorkEnv-&gt;setVal(Shared-&gt;WorkEnv-&gt;searchChild(Shared-&gt;Env));
00850   Shared-&gt;ShowCase-&gt;setVal(Shared-&gt;ShowCase-&gt;searchChild(Shared-&gt;WorldDCS));
00851 
00852   <font class="comment">// Show Bounding Box</font>
00853   <font class="keywordflow">if</font> (BoundingBoxOn){
00854     Shared-&gt;WorkEnv-&gt;setVal(PFSWITCH_ON);
00855   }
00856 
00857   <font class="comment">// Show Control Panel</font>
00858   <font class="keywordflow">if</font>(Shared-&gt;ControlPanelOn){
00859     Shared-&gt;ShowCase-&gt;setVal(PFSWITCH_ON);
00860   }
00861 
00862   <font class="comment">// Initiate cull/draw for this frame.</font>
00863   pfFrame();
00864 }
00865 
00866 
00867 
00868 <font class="comment">// Draw process callback</font>
<a name="l00869"></a><a class="code" href="class_RenderPerformer.html#e0">00869</a> <font class="keywordtype">void</font> <a class="code" href="class_RenderPerformer.html#e0">RenderPerformer::DrawChannel</a>(pfChannel *chan, <font class="keywordtype">void</font> *)<font class="keyword"> </font>{
00870   chan-&gt;clear();
00871   pfDraw();
00872 }
00873 
00874 
</div></pre><HEAD>
<TITLE>Motion Strategy Library</TITLE>
</HEAD>

<p>

<hr>

Web page maintained by 
<a href="http://janowiec.cs.iastate.edu/~lavalle">Steve LaValle</a><br>

Partial support provided by NSF CAREER Award IRI-970228 (LaValle),
Honda Research, and Iowa State University.<br>

Contributors:  Anna Atramentov, Peng Cheng, James Kuffner, Steve LaValle, and Libo Yang.<br>
